<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KB Pure Breath — Live AQI KL</title>
  <meta name="description" content="KB Pure Breath - Live Air Quality monitoring Kuala Lumpur (OpenAQ v3) - PM2.5, PM10" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --accent1:#2bb6b6;
      --accent2:#4aa0e6;
      --muted:rgba(15,23,42,0.7);
      --glass-bg: rgba(255,255,255,0.06);
      --card-bg: rgba(255,255,255,0.92);
      --text-on-glass: rgba(255,255,255,0.95);
      --maxw:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, Poppins, system-ui; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    body{
      background-image: url('klcc-bg.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color:#071129;
      padding-bottom:120px;
    }
    .page-overlay{ position:fixed; inset:0; background:linear-gradient(180deg, rgba(6,21,34,0.48), rgba(6,21,34,0.32)); z-index:0; pointer-events:none; }
    .page{ position:relative; z-index:2; max-width:var(--maxw); margin:0 auto; padding:28px; }

    header{ display:flex; align-items:center; gap:16px; margin-bottom:18px; flex-wrap:wrap;}
    .logo{ width:110px; height:110px; border-radius:14px; overflow:hidden; box-shadow:0 12px 40px rgba(0,0,0,0.35); background:var(--glass-bg); flex:0 0 110px; }
    .logo img{ width:100%; height:100%; object-fit:contain; display:block; }
    .site-title{ color:var(--text-on-glass) }
    .site-title h1{ margin:0; font-size:26px; font-weight:700; text-shadow:0 2px 6px rgba(0,0,0,0.35) }
    .site-title p{ margin:4px 0 0 0; color:rgba(255,255,255,0.9); font-size:13px }

    nav{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    nav a{ color:rgba(255,255,255,0.95); text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:600; }
    nav a:hover{ background: rgba(255,255,255,0.06); }

    .glass{ background:var(--glass-bg); border-radius:12px; padding:14px; color:var(--text-on-glass); backdrop-filter: blur(6px) saturate(110%); -webkit-backdrop-filter: blur(6px) saturate(110%); box-shadow:0 8px 30px rgba(0,0,0,0.25) }

    .realtime{ display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; margin-bottom:18px; }
    .aqi-big{ padding:18px; border-radius:12px; color:var(--text-on-glass); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 12px 36px rgba(0,0,0,0.45) }
    .aqi-value{ font-size:72px; font-weight:800; margin:10px 0; letter-spacing:-1px }
    .aqi-cat{ font-size:18px; margin-top:6px; color:rgba(255,255,255,0.95) }
    .aqi-meta{ margin-top:8px; color:rgba(255,255,255,0.85); font-size:13px }

    .side{ background:var(--card-bg); color:#071129; border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(2,6,23,0.12); min-height:220px; }
    .chart-wrap{ height:220px; position:relative; }

    .pm-row{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap }
    .pm-box{ flex:1 1 120px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.06); color:var(--text-on-glass); text-align:center }

    .poster-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:14px; margin-top:12px; }
    .poster-card{ background: rgba(255,255,255,0.06); border-radius:10px; padding:10px; text-align:center; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,0.28) }
    .poster-card img{ width:100%; height:auto; border-radius:8px; display:block; }

    .faq{ margin-top:18px }
    .accordion-item{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px; margin-bottom:12px; overflow:hidden; color:#fff; box-shadow:0 8px 24px rgba(0,0,0,0.2) }
    .accordion-q{ padding:12px 14px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-weight:700 }
    .accordion-a{ padding:0 14px 14px 14px; display:none; color:rgba(255,255,255,0.9); font-weight:400 }

    .contact-grid{ display:grid; grid-template-columns:1fr 320px; gap:18px; margin-top:18px; }
    .card{ background:var(--card-bg); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(2,6,23,0.12); color:#071129 }

    footer{ margin-top:28px; padding:18px; text-align:center; color:rgba(255,255,255,0.9) }

    .wa-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; border-radius:999px; padding:8px 10px; text-decoration:none; font-weight:700; box-shadow:0 8px 24px rgba(0,0,0,0.2) }

    @media(max-width:980px){
      .realtime{ grid-template-columns:1fr }
      .contact-grid{ grid-template-columns:1fr }
      header{ gap:12px }
      .aqi-value{ font-size:48px }
      .chart-wrap{ height:180px }
    }

    /* drawer styles (manuskrip) */
    .drawer{border-radius:10px;border:1px solid #eef3fb;padding:8px;background:#fff}
    .drawer-toggle{display:flex;gap:8px;align-items:center}
    .drawer-content{max-height:0;overflow:hidden;transition:max-height .28s ease;padding:0 8px}
    .drawer-open .drawer-content{max-height:900px;padding:8px 8px 16px 8px}
    .file-missing{padding:12px;background:#fff3f3;border-radius:8px;border:1px solid #ffd6d6;color:#922; margin-top:8px}
    .file-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .file-actions a{display:inline-block;padding:8px 10px;border-radius:8px;background:#f3f4f6;color:#072;text-decoration:none;font-weight:700}
  </style>
</head>
<body>
  <div class="page-overlay" aria-hidden="true"></div>

  <main class="page" role="main">
    <!-- Header -->
    <header>
      <div class="logo" aria-hidden="true">
        <img src="logo.png" alt="KB Pure Breath logo" onerror="this.style.display='none'">
      </div>
      <div class="site-title">
        <h1>KB Pure Breath</h1>
        <p>Live Air Quality Monitoring — Kuala Lumpur</p>
      </div>

      <nav aria-label="Main navigation">
        <a href="#aduan">Aduan</a>
        <a href="#realtime">Realtime</a>
        <a href="#poster">Poster</a>
        <a href="#infographic">Infographic</a>
        <a href="#manuskrip">Manuskrip</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact Us</a>
      </nav>
    </header>

    <!-- 1) ADUAN -->
    <section id="aduan" style="margin-top:6px">
      <div class="complain" role="region" aria-label="Complain box" style="background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:14px;border-radius:12px;color:#fff">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
          <div>
            <strong style="font-size:18px">Laporkan isu pencemaran udara</strong>
            <div style="font-size:13px;margin-top:6px">Lapor sumber pencemaran, bau pelik atau kejadian berkaitan udara terus melalui borang aduan.</div>
          </div>
          <div>
            <button onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSeNpSIZy-BT5JPAQddddWRe5TvFEo1-7szVrZbcamtgcULU9A/viewform?usp=header','_blank')" style="background:#fff;color:var(--accent2);padding:10px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer">Buka Borang Aduan</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 2) GRAF REALTIME -->
    <section id="realtime" class="realtime" aria-labelledby="realtime-heading" style="margin-top:18px">
      <div class="aqi-big glass" id="aqiCard" role="region" aria-labelledby="realtime-heading">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="realtime-heading" style="font-weight:700">Real-Time Air Quality</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.85)">Source: OpenAQ v3 — default: Kuala Lumpur (Coordinates)</div>
          </div>
          <div style="font-size:13px;color:rgba(255,255,255,0.85)">Updated: <span id="aqiUpdated">--</span></div>
        </div>

        <div style="margin-top:12px">
          <div class="aqi-value" id="aqiValue">--</div>
          <div class="aqi-cat" id="aqiCat">—</div>
          <div class="aqi-meta" id="aqiMeta">PM2.5: -- µg/m³ • PM10: -- µg/m³</div>

          <div class="pm-row" aria-hidden="false">
            <div class="pm-box"><div style="font-size:12px;color:rgba(255,255,255,0.85)">PM2.5</div><div id="pm25Box" style="font-size:20px;margin-top:6px">--</div></div>
            <div class="pm-box"><div style="font-size:12px;color:rgba(255,255,255,0.85)">PM10</div><div id="pm10Box" style="font-size:20px;margin-top:6px">--</div></div>
            <div class="pm-box"><div style="font-size:12px;color:rgba(255,255,255,0.85)">AQI</div><div id="aqiBox" style="font-size:20px;margin-top:6px">--</div></div>
          </div>
        </div>
      </div>

      <aside class="side" aria-labelledby="charts-heading">
        <div id="charts-heading" style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700;color:#0f172a">Particulate Matter Trend</div>
          <div style="font-size:12px;color:var(--muted)">Recent readings</div>
        </div>

        <div class="chart-wrap" style="margin-top:12px">
          <canvas id="pmChart" aria-label="PM2.5 and PM10 trend" role="img"></canvas>
        </div>

        <div style="margin-top:12px;font-size:13px;color:var(--muted)">
          Placeholder data shown initially. OpenAQ v3 used for real readings.
        </div>
      </aside>
    </section>

    <!-- 3) POSTER AWARENESS -->
    <section id="poster" style="margin-top:18px">
      <h2 style="color:var(--text-on-glass);margin:0 0 10px 0">Poster Awareness</h2>
      <div class="poster-grid">
        <div class="poster-card">
          <img src="poster%201.png" alt="Poster 1">
          <div style="margin-top:8px">
            <a href="https://www.canva.com/design/DAG3kf01Gig/Zf2Stx1G6IcfuNncKkOK7g/edit" target="_blank" rel="noopener noreferrer" class="wa-btn" style="display:inline-block;padding:6px 10px;margin-right:8px">Edit Canva A</a>
            <a href="https://www.canva.com/design/DAG5JXH0LV4/GsfkXATXVpdSoq1lG5pLeg/edit" target="_blank" rel="noopener noreferrer" class="wa-btn" style="display:inline-block;padding:6px 10px">Edit Canva B</a>
          </div>
        </div>
      </div>
    </section>

    <!-- 4) INFOGRAFIK -->
    <section id="infographic" class="glass" style="margin-top:18px;padding:16px" aria-labelledby="infog">
      <h2 id="infog" style="margin:0 0 10px 0;color:var(--text-on-glass)">Infographic — Respiratory Tract & Particulate Matter</h2>
      <div style="text-align:center">
        <img src="https://www.researchgate.net/profile/Fiorella-Barraza/publication/321993233/figure/fig14/AS:574185194704903@1513907826653/Respiratory-tract-and-particulate-matter-PM-size-classification-Modified-from.png" alt="Respiratory tract and PM" style="max-width:100%;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.25)">
      </div>
    </section>

    <!-- 5) MANUSKRIP (drawer, readable) -->
    <section id="manuskrip" style="margin-top:18px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">Manuskrip (PDF)</h3>
            <div class="small" style="margin-top:6px">Manuskrip dimuatkan dari fail <code>/manuscript-kbp.pdf</code> di root — pratonton dalam drawer (untuk elakkan halaman penuh dipenuhi PDF).</div>
          </div>
          <div>
            <button class="btn" id="openDrawerBtn">Buka Manuskrip</button>
          </div>
        </div>

        <div style="margin-top:12px" class="drawer" id="manDrawer">
          <div class="drawer-toggle">
            <div class="small">Klik butang untuk buka/tutup pratonton PDF. Jika fail besar, muatkan boleh ambil masa.</div>
          </div>
          <div class="drawer-content" id="drawerContent">
            <div id="pdfPlaceholder" style="min-height:120px;display:flex;align-items:center;justify-content:center">
              <div class="small">Mencari manuskrip…</div>
            </div>
            <div id="pdfFrameWrap" style="display:none">
              <iframe id="pdfFrame" src="" style="width:100%;height:600px;border:0;border-radius:6px"></iframe>
              <div style="margin-top:8px"><a class="link" id="pdfDirectLink" href="#" target="_blank">Buka PDF dalam tab baru / muat turun</a></div>
            </div>

            <div id="pdfMissing" style="display:none" class="file-missing">
              <div>Kami tidak menemui fail <code>/manuscript-kbp.pdf</code> di repo (atau file tidak dapat dimuat). Buka pautan berikut untuk muat turun atau upload semula.</div>
              <div class="file-actions">
                <a id="rawPdf" href="https://raw.githubusercontent.com/zieainbalqis-wq/kb-pure-breath/main/manuscript-kbp.pdf" target="_blank" rel="noopener noreferrer">Buka Raw (jika ada)</a>
                <a id="uploadBtn" href="https://github.com/zieainbalqis-wq/kb-pure-breath/upload/main?path=" target="_blank" rel="noopener noreferrer">Upload Manuskrip ke repo</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- 6) FAQ -->
    <section id="faq" style="margin-top:18px">
      <h2 style="color:var(--text-on-glass);margin:0 0 10px 0">FAQ — Kesan Particulate Matter terhadap Kesihatan</h2>
      <div class="faq">
        <div class="accordion-item">
          <div class="accordion-q">Apakah PM2.5 dan mengapa ia berbahaya? <span>+</span></div>
          <div class="accordion-a">PM2.5 ialah partikel halus (≤2.5 µm) yang boleh menembusi alveoli paru-paru dan masuk ke dalam peredaran darah. Ia dikaitkan dengan asma, penyakit jantung, dan peningkatan kadar kematian pramatang.</div>
        </div>

        <div class="accordion-item">
          <div class="accordion-q">Apakah kesan pendedahan jangka panjang kepada PM2.5? <span>+</span></div>
          <div class="accordion-a">Pendedahan jangka panjang boleh menyebabkan penyakit kronik seperti COPD, penurunan fungsi pulmonari, hipertensi, strok dan penyakit kardiovaskular.</div>
        </div>

        <div class="accordion-item">
          <div class="accordion-q">Bagaimana PM10 berbeza dari PM2.5 dalam kesan kesihatan? <span>+</span></div>
          <div class="accordion-a">PM10 lebih besar dan biasanya menyebabkan iritasi saluran pernafasan atas. PM2.5 menembusi lebih dalam dan lebih berbahaya pada jangka panjang.</div>
        </div>

        <div class="accordion-item">
          <div class="accordion-q">Apa tindakan segera jika bacaan AQI tidak sihat? <span>+</span></div>
          <div class="accordion-a">Kurangkan aktiviti luar, pakai topeng N95, tutup tingkap, gunakan penapis udara, dan dapatkan rawatan jika mengalami masalah pernafasan.</div>
        </div>

        <div class="accordion-item">
          <div class="accordion-q">Bagaimana komuniti boleh membantu mengurangkan pendedahan kepada PM? <span>+</span></div>
          <div class="accordion-a">Laporkan sumber pencemaran, kurangkan pembakaran terbuka, sokong pengangkutan awam dan program penanaman pokok.</div>
        </div>
      </div>
    </section>

    <!-- 7) CONTACT US -->
    <section id="contact" style="margin-top:18px">
      <div class="contact-grid">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Hubungi Kami</h3>
          <p style="color:var(--muted);margin:0 0 12px 0">Hubungi ahli kumpulan untuk maklumat lanjut atau kolaborasi.</p>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">
            <div style="text-align:center">
              <img src="iqbal.png" alt="Iqbal" style="width:92px;height:92px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 8px">
              <strong>Iqbal</strong>
              <div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/60179912306" target="_blank" rel="noopener noreferrer">WhatsApp</a></div>
            </div>

            <div style="text-align:center">
              <img src="syakirullah.png" alt="Syakirullah" style="width:92px;height:92px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 8px">
              <strong>Syakirullah</strong>
              <div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/60172131363" target="_blank" rel="noopener noreferrer">WhatsApp</a></div>
            </div>

            <div style="text-align:center">
              <img src="wan_zulkhairi.png" alt="Wan Zulkhairi" style="width:92px;height:92px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 8px">
              <strong>Wan Zulkhairi</strong>
              <div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/60145147998" target="_blank" rel="noopener noreferrer">WhatsApp</a></div>
            </div>

            <div style="text-align:center">
              <img src="zhafri.png" alt="Zhafri" style="width:92px;height:92px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 8px">
              <strong>Zhafri</strong>
              <div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/60138487104" target="_blank" rel="noopener noreferrer">WhatsApp</a></div>
            </div>

            <div style="text-align:center">
              <img src="zie_ain_balqis.png" alt="Zie Ain Balqis" style="width:92px;height:92px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 8px">
              <strong>Zie Ain Balqis</strong>
              <div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/60172370158" target="_blank" rel="noopener noreferrer">WhatsApp</a></div>
            </div>
          </div>

        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Quick Tips</h3>
          <ul style="margin:0;padding-left:18px;color:var(--muted)">
            <li>Gunakan mask N95 jika AQI tidak sihat.</li>
            <li>Kurangkan aktiviti luar ketika jerebu atau bacaan PM tinggi.</li>
            <li>Tutup tingkap & guna penapis udara di dalam rumah.</li>
          </ul>
          <div style="margin-top:12px;font-size:13px;color:var(--muted)">Data source: OpenAQ v3 • Attribution required.</div>
        </div>
      </div>
    </section>

    <footer style="margin-top:28px">© 2025 KB Pure Breath • Built for public monitoring</footer>
  </main>

  <!-- floating WhatsApp copilot -->
  <a class="wa-btn" href="https://wa.me/18772241042" target="_blank" rel="noopener noreferrer" style="position:fixed;right:18px;bottom:18px;z-index:999">Chat Copilot</a>

  <script>
(function(){

  /* ============================================================
     CONFIG — OPENAQ (Coordinates KL, NO API KEY NEEDED)
  ============================================================ */
  const API_ENDPOINT =
    "https://api.openaq.org/v3/measurements?coordinates=3.1390%2C101.6869&radius=20000&limit=100&parameter=pm25%2Cpm10";

  const REFRESH_MS = 5 * 60 * 1000; // 5 minutes
  const RAW_PDF_URL = 'https://raw.githubusercontent.com/zieainbalqis-wq/kb-pure-breath/main/manuscript-kbp.pdf';
  const PDF_PATH = '/manuscript-kbp.pdf';

  // DOM references
  const aqiValueEl = document.getElementById('aqiValue');
  const aqiCatEl = document.getElementById('aqiCat');
  const aqiMetaEl = document.getElementById('aqiMeta');
  const aqiUpdatedEl = document.getElementById('aqiUpdated');
  const pm25Box = document.getElementById('pm25Box');
  const pm10Box = document.getElementById('pm10Box');
  const aqiBox = document.getElementById('aqiBox');
  const aqiCard = document.getElementById('aqiCard');

  /* ============================================================
     CHART INIT
  ============================================================ */
  const ctx = document.getElementById('pmChart').getContext('2d');
  const labels = [], series25 = [], series10 = [];

  const accent1 = getComputedStyle(document.documentElement).getPropertyValue('--accent1') || '#2bb6b6';
  const accent2 = getComputedStyle(document.documentElement).getPropertyValue('--accent2') || '#4aa0e6';

  const pmChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'PM2.5 (µg/m³)',
          data: series25,
          borderColor: accent1,
          backgroundColor: 'rgba(43,182,182,0.12)',
          tension: 0.35,
          pointRadius: 1
        },
        {
          label: 'PM10 (µg/m³)',
          data: series10,
          borderColor: accent2,
          backgroundColor: 'rgba(74,160,230,0.12)',
          tension: 0.35,
          pointRadius: 1
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true } },
      plugins:{ legend:{ labels:{ color: '#000' }, position:'top' } }
    }
  });


  /* ============================================================
     AQI CATEGORY COLORING
  ============================================================ */
  function aqiCategoryFromValue(a){
    if(a===null || isNaN(a)) return {cat:'Tiada Data', color:'#9AA4B2'};
    if(a<=50) return {cat:'Baik / Good', color:'#26a69a'};
    if(a<=100) return {cat:'Sederhana', color:'#ffca28'};
    if(a<=150) return {cat:'Tidak Sihat (Sensitif)', color:'#ff7043'};
    if(a<=200) return {cat:'Tidak Sihat', color:'#e53935'};
    if(a<=300) return {cat:'Sangat Tidak Sihat', color:'#8e24aa'};
    return {cat:'Berbahaya', color:'#6b0018'};
  }


  /* ============================================================
     PM2.5 → AQI (EPA Standard)
  ============================================================ */
  function pm25ToAqi(pm) {
    if (pm == null || !isFinite(pm)) return null;

    const ranges = [
      [0.0,12.0,  0,50],
      [12.1,35.4, 51,100],
      [35.5,55.4, 101,150],
      [55.5,150.4,151,200],
      [150.5,250.4,201,300],
      [250.5,350.4,301,400],
      [350.5,500.4,401,500]
    ];

    for(const r of ranges){
      const [cl,ch,il,ih] = r;
      if(pm>=cl && pm<=ch){
        return Math.round(((ih-il)/(ch-cl))*(pm-cl) + il);
      }
    }
    return null;
  }


  /* ============================================================
     FETCH REALTIME FROM OPENAQ v3
     (Coordinates KL — No API key required)
  ============================================================ */
  async function updateFromApi(){
    try{
      const res = await fetch(API_ENDPOINT, { cache:'no-store' });
      if(!res.ok) throw new Error("API returned " + res.status);

      const json = await res.json();
      const results = json.results || [];

      let pm25 = null, pm10 = null;
      const trend = [];

      for(const r of results){
        const param = (r.parameter || "").toLowerCase();
        const value = r.value != null ? Number(r.value) : null;

        const time = r.date ? (r.date.local || r.date.utc) : null;
        const formatted = time ? new Date(time).toLocaleTimeString('en-GB',{hour12:false}) : "--:--:--";

        trend.push({
          time: formatted,
          pm25: param=="pm25" ? value : null,
          pm10: param=="pm10" ? value : null
        });

        if(param=="pm25" && pm25===null && value!=null) pm25 = value;
        if(param=="pm10" && pm10===null && value!=null) pm10 = value;
      }

      // Combine by time for chart
      const byTime = {};
      trend.forEach(pt=>{
        if(!byTime[pt.time]) byTime[pt.time] = {time:pt.time, pm25:null, pm10:null};
        if(pt.pm25!=null) byTime[pt.time].pm25 = pt.pm25;
        if(pt.pm10!=null) byTime[pt.time].pm10 = pt.pm10;
      });

      const finalTrend = Object.values(byTime).slice(0,20);

      const aqi = pm25 != null ? pm25ToAqi(pm25) : null;

      // Update UI
      pm25Box.textContent = pm25!=null ? pm25.toFixed(1) : "--";
      pm10Box.textContent = pm10!=null ? pm10.toFixed(1) : "--";
      aqiBox.textContent  = aqi!=null ? aqi : "--";
      aqiValueEl.textContent = aqi!=null ? aqi : "--";

      const cat = aqiCategoryFromValue(aqi);
      aqiCatEl.textContent = cat.cat;
      aqiCard.style.boxShadow = `0 14px 40px ${cat.color}55`;

      aqiMetaEl.textContent = `PM2.5: ${pm25!=null?pm25.toFixed(1):"--"} µg/m³ • PM10: ${pm10!=null?pm10.toFixed(1):"--"} µg/m³`;
      aqiUpdatedEl.textContent = new Date().toLocaleString();

      // Update Chart
      labels.length = 0; series25.length = 0; series10.length = 0;

      finalTrend.forEach(pt=>{
        labels.push(pt.time);
        series25.push(pt.pm25);
        series10.push(pt.pm10);
      });

      pmChart.update();

    }catch(err){
      console.error("Realtime error:", err);
      aqiMetaEl.textContent = "⚠️ Data tidak dapat dimuatkan (OpenAQ v3).";
    }
  }


  /* ============================================================
     INITIAL CHART SEED
  ============================================================ */
  (function seed(){
    for(let i=10;i>0;i--){
      labels.push("--:--:--");
      series25.push(null);
      series10.push(null);
    }
    pmChart.update();
  })();


  /* ============================================================
     REFRESH INTERVAL
  ============================================================ */
  updateFromApi();
  setInterval(updateFromApi, REFRESH_MS);


  /* ============================================================
     MANUAL REFRESH ON CLICK
  ============================================================ */
  aqiCard.style.cursor = "pointer";
  aqiCard.addEventListener('click', updateFromApi);


  /* ============================================================
     FAQ ACCORDION
  ============================================================ */
  document.querySelectorAll('.accordion-q').forEach(q=>{
    q.addEventListener('click', ()=>{
      const a = q.nextElementSibling;

      document.querySelectorAll('.accordion-a').forEach(x=>x.style.display='none');
      document.querySelectorAll('.accordion-q span').forEach(s=>s.textContent='+');

      if(a.style.display!=='block'){
        a.style.display='block';
        q.querySelector('span').textContent='−';
      }
    });

    q.setAttribute('tabindex','0');
    q.addEventListener('keydown', e=>{ if(e.key==="Enter"||e.key===" ") q.click(); });
  });


  /* ============================================================
     MANUSKRIP DRAWER
  ============================================================ */
  const openBtn = document.getElementById('openDrawerBtn');
  const manDrawer = document.getElementById('manDrawer');
  const pdfPlaceholder = document.getElementById('pdfPlaceholder');
  const pdfFrameWrap = document.getElementById('pdfFrameWrap');
  const pdfFrame = document.getElementById('pdfFrame');
  const pdfDirectLink = document.getElementById('pdfDirectLink');
  const pdfMissing = document.getElementById('pdfMissing');

  async function checkPdfFile(url) {
    try {
      const head = await fetch(url, {method:'HEAD', cache:'no-store'});
      return head.ok;
    } catch { return false; }
  }

  async function loadPdf(){
    pdfPlaceholder.style.display = 'none';

    if(await checkPdfFile(PDF_PATH)){
      pdfFrame.src = PDF_PATH;
      pdfDirectLink.href = PDF_PATH;
      pdfFrameWrap.style.display = 'block';
      pdfMissing.style.display = 'none';
      return;
    }

    if(await checkPdfFile(RAW_PDF_URL)){
      pdfFrame.src = RAW_PDF_URL;
      pdfDirectLink.href = RAW_PDF_URL;
      pdfFrameWrap.style.display = 'block';
      pdfMissing.style.display = 'none';
      return;
    }

    pdfFrameWrap.style.display='none';
    pdfMissing.style.display='block';
  }

  if(openBtn){
    let opened = false;
    openBtn.addEventListener('click', async ()=>{
      opened=!opened;
      if(opened){
        manDrawer.classList.add('drawer-open');
        openBtn.textContent = "Tutup Manuskrip";
        await loadPdf();
      } else {
        manDrawer.classList.remove('drawer-open');
        openBtn.textContent = "Buka Manuskrip";
      }
    });
  }

})();
</script>

</body>
</html>

